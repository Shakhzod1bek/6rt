<!DOCTYPE html>
<html lang="uz">

<head>
   <meta charset="UTF-8">
   <title>Billiard Timer</title>

   <style>
      body {
         font-family: Arial;
         background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
         width: 590px;
         max-width: 100%;
         margin: 0 auto;

      }

      h1 {
         text-align: center;
         color: #000000;
         font-size: 26px;
         position: absolute;
         top: 10px;
         right: 1rem;
      }

      p {
         font-size: 26px;
         transform: scaleY(1.5);
         display: inline-block;
         font-weight: 700;
      }

      .timer {
         display: flex;
         text-align: center;
         align-items: center;
         flex-direction: column;
         background: #fff;
         margin: 12px;
         padding: 14px;
         width: 550px;
         max-width: 100%;
         border-radius: 12px;
         font-size: 18px;
         box-shadow: 0 6px 18px rgba(0, 0, 0, .15);
         border-top: 6px solid #2e7d32;
         margin: 40px 0px;
      }

      h3 {
         font-size: 35px;
         transform: scaleY(2);
         display: inline-block;
      }

      .cost {
         font-weight: bold
      }

      .status {
         font-weight: bold;
         color: #2e7d32
      }

      input {
         width: 90%;
         height: 3.5rem;
         font-size: 26px;
         margin: 6px 0;
         border: 2px solid;
      }

      button {
         height: 65px;
         width: 50%;
         padding: 10px;
         margin-top: 6px;
         font-weight: 00;
         border: none;
         border-radius: 8px;
         font-size: 28px;
         cursor: pointer
      }

      .start {
         background: #03ff10;
         color: #000000
      }

      .stop {
         background: #07a2f6;
         color: #fff
      }

      .reset {
         background: #ff0505;
         color: #fff
      }

      #dataBtn {
         position: fixed;
         top: 20px;
         left: 15px;
         width: 100px;
         height: 100px;
         border-radius: 50%;
         background: #ff9800;
         display: flex;
         justify-content: center;
         align-items: center;
         font-size: 45px;
         cursor: pointer
      }

      .time {
         font-weight: bold;
         font-size: 45px;
         transform: scaleY(1.3);
         display: inline-block;
      }

      #dataTab {
         display: none;
         position: fixed;
         inset: 0;
         margin: 0 auto;
         width: 650px;
         max-width: 100%;
         background: #f1f8e9;
         padding: 12px;
         overflow: auto
      }

      #dataTab h2 {
         text-align: center
      }

      .log {
         background: #fff;
         padding: 10px;
         margin-bottom: 8px;
         border-radius: 10px;
         box-shadow: 0 4px 10px rgba(0, 0, 0, .1);
         font-size: 14px
      }

      .del {
         background: #d32f2f;
         color: #fff;
         padding: 6px;
         border-radius: 6px;
         text-align: center;
         margin-top: 6px;
         cursor: pointer
      }

      .clearAll {
         background: #ee1212;
         color: #fff;
         font-size: 22px;
         font-weight: 800;
         padding: 10px;
         border-radius: 8px;
         text-align: center;
         margin: 10px 0;
         cursor: pointer
      }
   </style>
</head>

<body>

   <h1>üé± BILLIARD</h1>

   <script>
      for (let i = 1; i <= 4; i++) {
         document.write(`
 <div class="timer">
 <h3>${i}-Stol</h3>

 <input type="text" placeholder="Sharh yozish(majburiy)">

 <p><span class="status">‚è∏ To‚Äòxtagan</span></p>
 <p>Vaqt: <span class="time">00:00:00:000</span></p>
 <p>Summa: <span class="cost">0</span> so‚Äòm</p>

 <button class="start" onclick="start(this)">Start</button>
 <button class="stop" onclick="stop(this)">Stop</button>
 <button class="reset" onclick="resetT(this)">Reset</button>
 </div>
 `)
      }
   </script>

   <div id="dataBtn" onclick="openTab()">üì¶</div>

   <div id="dataTab">
      <h2>üìä DATA PACK</h2>
      <div class="clearAll" onclick="clearAll()">üóë Barchasini tozalash</div>
      <button onclick="closeTab()" style="background: #4f5150;color: #fff;"><span style="color: red;">‚ùå</span>
         Yopish</button>
      <div id="logs"></div>
   </div>

   <script>
      const RATE = 30000;
      const LOG_KEY = "billiard_logs";
      const STATE_KEY = "billiard_state";
      const timers = new Map();

      /* ======================
         START
      ====================== */
      function start(btn) {
         const box = btn.closest(".timer");
         if (timers.has(box)) return;

         const comment = box.querySelector("input").value.trim();
         if (!comment) {
            alert("Sharh yozilmasdan START bosib bo‚Äòlmaydi!");
            return;
         }

         const now = Date.now();
         box.comment = comment;

         // agar oldin to‚Äòxtagan bo‚Äòlsa davom ettiramiz
         box.startTime = now;
         box.elapsed = box.elapsed || 0;
         box.running = true;

         box.querySelector(".status").innerText =
            "üü¢ Boshlandi: " + new Date(now).toLocaleTimeString();

         runTimer(box);
         saveState();
      }

      /* ======================
         TIMER ISHLASHI
      ====================== */
      function runTimer(box) {
         if (timers.has(box)) return;

         const int = setInterval(() => {
            const ms = box.elapsed + (Date.now() - box.startTime);
            updateUI(box, ms);
         }, 50);

         timers.set(box, int);
      }

      /* ======================
         STOP
      ====================== */
      function stop(btn) {
         const box = btn.closest(".timer");
         if (!timers.has(box)) return;

         clearInterval(timers.get(box));
         timers.delete(box);

         // yig‚Äòilgan vaqtni saqlaymiz
         box.elapsed = box.elapsed + (Date.now() - box.startTime);
         box.running = false;

         const stopTime = Date.now();
         saveLog(box, box.comment, box.startTime, stopTime, box.elapsed);

         box.startTime = null;
         box.querySelector(".status").innerText =
            "‚èπ To‚Äòxtadi: " + new Date(stopTime).toLocaleTimeString();

         saveState();
      }

      /* ======================
         RESET
      ====================== */
      function resetT(btn) {
         const box = btn.closest(".timer");
         if (timers.has(box)) {
            clearInterval(timers.get(box));
            timers.delete(box);
         }

         box.startTime = null;
         box.elapsed = 0;
         box.running = false;
         box.comment = "";

         box.querySelector("input").value = "";
         box.querySelector(".time").innerText = "00:00:00:000";
         box.querySelector(".cost").innerText = "0";
         box.querySelector(".status").innerText = "‚è∏ To‚Äòxtagan";

         saveState();
      }

      /* ======================
         UI UPDATE
      ====================== */
      function updateUI(box, ms) {
         let h = Math.floor(ms / 3600000);
         let m = Math.floor((ms % 3600000) / 60000);
         let s = Math.floor((ms % 60000) / 1000);
         let mi = ms % 1000;

         box.querySelector(".time").innerText =
            `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}:${String(mi).padStart(3, "0")}`;

         box.querySelector(".cost").innerText =
            Math.round(ms / 3600000 * RATE).toLocaleString();
      }

      /* ======================
         LOG SAQLASH
      ====================== */
      function saveLog(box, comment, start, stop, elapsed) {
         const logs = JSON.parse(localStorage.getItem(LOG_KEY) || "[]");

         logs.push({
            stol: box.querySelector("h3").innerText,
            sharh: comment,
            start: new Date(start).toLocaleString(),
            stop: new Date(stop).toLocaleString(),
            vaqt: box.querySelector(".time").innerText,
            summa: Math.round(elapsed / 3600000 * RATE).toLocaleString()
         });

         localStorage.setItem(LOG_KEY, JSON.stringify(logs));
      }

      /* ======================
         STATE SAQLASH
      ====================== */
      function saveState() {
         const state = [];
         document.querySelectorAll(".timer").forEach((box, i) => {
            state.push({
               index: i,
               startTime: box.startTime,
               elapsed: box.elapsed || 0,
               running: box.running || false,
               comment: box.comment || "",
               status: box.querySelector(".status").innerText
            });
         });
         localStorage.setItem(STATE_KEY, JSON.stringify(state));
      }

      /* ======================
         STATE QAYTA TIKLASH
      ====================== */
      function loadState() {
         const state = JSON.parse(localStorage.getItem(STATE_KEY) || "[]");

         document.querySelectorAll(".timer").forEach((box, i) => {
            const s = state.find(x => x.index === i);
            if (!s) return;

            box.startTime = s.startTime;
            box.elapsed = s.elapsed || 0;
            box.running = s.running;
            box.comment = s.comment;

            box.querySelector("input").value = s.comment || "";
            box.querySelector(".status").innerText = s.status || "‚è∏ To‚Äòxtagan";

            // UI ni tiklaymiz
            updateUI(box, box.elapsed);

            if (s.running && s.startTime) {
               runTimer(box);
            }
         });
      }

      /* ======================
         DATA PACK (tabs)
      ====================== */
      function openTab() {
         document.getElementById("dataTab").style.display = "block";
         renderLogs();
      }
      function closeTab() {
         document.getElementById("dataTab").style.display = "none";
      }
      function renderLogs() {
         const box = document.getElementById("logs");
         box.innerHTML = "";
         const logs = JSON.parse(localStorage.getItem(LOG_KEY) || "[]");

         logs.forEach((l, i) => {
            const d = document.createElement("div");
            d.className = "log";
            d.innerHTML = `
   <b>${l.stol}</b><br>
   ‚úçÔ∏è <i>${l.sharh}</i><br>
   ‚ñ∂ ${l.start}<br>
   ‚èπ ${l.stop}<br>
   ‚è± ${l.vaqt}<br>
   üí∞ ${l.summa} so‚Äòm
   <div class="del" onclick="deleteOne(${i})">‚ùå O‚Äòchirish</div>
  `;
            box.appendChild(d);
         });
      }
      function deleteOne(i) {
         const logs = JSON.parse(localStorage.getItem(LOG_KEY) || "[]");
         logs.splice(i, 1);
         localStorage.setItem(LOG_KEY, JSON.stringify(logs));
         renderLogs();
      }
      function clearAll() {
         if (!confirm("Barchasi o‚Äòchirilsinmi?")) return;
         localStorage.removeItem(LOG_KEY);
         renderLogs();
      }

      /* ======================
         PAGE LOAD
      ====================== */
      window.onload = loadState;
   </script>

</body>

</html>
